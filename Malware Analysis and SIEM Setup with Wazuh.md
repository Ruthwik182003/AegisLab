
This guide provides a structured walkthrough for setting up a **Security Information and Event Management (SIEM)** system using **Wazuh**, configuring **File Integrity Monitoring (FIM)**, integrating with **VirusTotal**, and enabling **Active Response** to automatically mitigate detected malware.

---

## 1. Prerequisites

Before starting, ensure you have the following:

- **Ubuntu Linux** (for server and agent VMs)
    
- **VirtualBox** or **VMware** for virtualization
    
- **Wazuh Server, Dashboard, and Agent**
    
- **Wazuh File Integrity Monitoring (FIM)** enabled
    
- **VirusTotal API key** (free account available)
    

üí° **Tip:** For practice, use at least two VMs ‚Äî one as the Wazuh Manager and one as a monitored Agent.

---

## 2. Setting up the Environment

### Install Ubuntu Desktop (Optional GUI)

```bash
sudo apt install ubuntu-desktop -y
sudo systemctl set-default graphical.target
sudo dpkg --configure -a
```

### Install VirtualBox

Download from: [https://www.virtualbox.org/wiki/Downloads](https://www.virtualbox.org/wiki/Downloads)

### (Optional) VMware Tools

```bash
sudo apt install open-vm-tools
sudo apt install open-vm-tools-desktop
```

---

## 3. Install Wazuh

Run the official quickstart script on your **manager machine**:

```bash
curl -sO https://packages.wazuh.com/4.13/wazuh-install.sh && sudo bash ./wazuh-install.sh -a
```

Save the **username** and **password** provided after installation.

### Access Wazuh Dashboard

- Open browser ‚Üí `https://<your_server_ip>`
    
- Login with saved credentials
    

---

## 4. Deploying a Wazuh Agent

1. In the Wazuh Dashboard, select **Deploy New Agent**.
    
2. Choose the correct OS type (**DEB amd64 for Ubuntu**).
    
3. Enter the **Wazuh Manager IP**.
    
4. Copy the installation command and run it on the **Agent machine** (as root).
    
5. Start the agent using the given command.
    

‚úÖ The agent should now appear in the dashboard under **Active Agents**.

---

## 5. Configure File Integrity Monitoring (FIM)

On the **Wazuh Dashboard**:

1. Go to **Agent Management ‚Üí Groups**.
    
2. Click **Edit** on your group and paste:
    

```xml
<agent_config os="Linux">
  <syscheck>
    <directories realtime="yes" check_all="yes">/tmp/Malware</directories>
  </syscheck>
</agent_config>
```

### Verify FIM Functionality

On the **Agent machine**, run:

```bash
mkdir /tmp/Malware
chmod 777 /tmp/Malware
echo "hello" >> /tmp/Malware/hello.txt
```

Then check the **Dashboard ‚Üí Agents ‚Üí [Your Agent] ‚Üí FIM: Recent Events**.

---

## 6. VirusTotal Integration

### Get API Key

1. Create a free VirusTotal account.
    
2. Go to **User Profile ‚Üí API Keys**.
    
3. Copy your API key.
    

### Configure Integration

On the **Manager machine**, edit Wazuh config:

```bash
sudo nano /var/ossec/etc/ossec.conf
```

Add before `</ossec_config>`:

```xml
<integration>
  <name>virustotal</name>
  <api_key>YOUR_API_KEY</api_key>
  <group>syscheck</group>
  <alert_format>json</alert_format>
</integration>
```

Restart Wazuh Manager:

```bash
sudo systemctl restart wazuh-manager
```

### Test VirusTotal Alerts

On the **Agent machine**, download the **EICAR test file**:

```bash
curl https://secure.eicar.org/eicar.com -o /tmp/Malware/eicar
```

Check **Dashboard ‚Üí Threat Hunting ‚Üí Events** for a VirusTotal alert.

‚ö†Ô∏è The EICAR file is **not real malware** but is universally recognized as a safe test signature.

---

## 7. Enable Active Response (Auto-Removal)

### Create Active Response Script

On the **Agent machine**:

```bash
sudo apt install jq -y
cd /var/ossec/active-response/bin
sudo nano remove-threat.sh
```

Paste the script from [Wazuh documentation](https://documentation.wazuh.com/current/proof-of-concept-guide/detect-remove-malware-virustotal.html). Then:

```bash
sudo chmod 750 /var/ossec/active-response/bin/remove-threat.sh
sudo chown root:wazuh /var/ossec/active-response/bin/remove-threat.sh
```

### Configure Manager for Active Response

Edit Wazuh config:

```bash
sudo nano /var/ossec/etc/ossec.conf
```

Add:

```xml
<command>
  <name>remove-threat</name>
  <executable>remove-threat.sh</executable>
  <timeout_allowed>no</timeout_allowed>
</command>

<active-response>
  <disabled>no</disabled>
  <command>remove-threat</command>
  <location>local</location>
  <rules_id>87105</rules_id>
</active-response>
```

Restart Manager:

```bash
sudo systemctl restart wazuh-manager
```

---

## 8. Verify Active Response

On the **Agent machine**, open a terminal alongside `/tmp/Malware`. Then run:

```bash
curl https://secure.eicar.org/eicar.com -o /tmp/Malware/eicar
```

Within a few seconds, the file will be **automatically deleted** by Wazuh.

‚úÖ This confirms Active Response is working.

---

## 9. Troubleshooting

- **Agent not connecting?** Check `/var/ossec/logs/ossec.log`.
    
- **Dashboard not loading?** Restart services:
    
    ```bash
    sudo systemctl restart wazuh-manager wazuh-dashboard wazuh-indexer
    ```
    
- **VirusTotal errors?** Ensure API key is valid and within free-tier limits (4 requests/min).
    

---

## 10. Conclusion

With this setup:

- Wazuh monitors files for changes (**FIM**).
    
- Suspicious files are sent to **VirusTotal** for analysis.
    
- If malicious, **Active Response** deletes them automatically.
    

You now have a functioning **SIEM with Malware Detection & Automated Response**!